<script>
const CHANNEL_ID = "3208976";
const READ_API_KEY = "OACUOG6F0U6AJRIT";
const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=500`;

let rawFeeds = [];
let filteredFeeds = [];
let currentFilter = "all";

function fullTS(d) {
  return d.toLocaleString("en-GB", {
    day: "2-digit", month: "long", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
}

function shortDate(d) {
  return d.toLocaleDateString("en-GB", {
    day: "2-digit", month: "short", year: "numeric"
  });
}

function applyFilter() {
  const now = new Date();
  filteredFeeds = [...rawFeeds];

  if (currentFilter === "7d") {
    const c = new Date(now); 
    c.setDate(c.getDate() - 7);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= c);
  }

  if (currentFilter === "1m") {
    const c = new Date(now); 
    c.setMonth(c.getMonth() - 1);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= c);
  }

  updateUI();
}

function setFilter(f) {
  currentFilter = f;
  applyFilter();
}

function setCustom() {
  const f = new Date(document.getElementById("fromDate").value);
  const t = new Date(document.getElementById("toDate").value);

  filteredFeeds = rawFeeds.filter(x => {
    const d = new Date(x.created_at);
    return d >= f && d <= t;
  });

  currentFilter = "custom";
  updateUI();
}

const chart = new Chart(document.getElementById("chart"), {
  type: "line",
  data: { labels: [], datasets: [] },
  options: {
    interaction: { mode: "nearest", intersect: false },
    plugins: {
      title: {
        display: true,
        text: "Air Quality Trend (All Data)",
        color: "#e5e7eb",
        font: { size: 16 }
      }
    }
  }
});

function updateUI() {
  if (!filteredFeeds.length) return;

  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  // ----- Dynamic chart title -----
  let titleText = "Air Quality Trend";
  if (currentFilter === "7d") titleText += " (Last 7 Days)";
  else if (currentFilter === "1m") titleText += " (Last 1 Month)";
  else if (currentFilter === "custom")
    titleText += ` (${shortDate(start)} â†’ ${shortDate(end)})`;
  else titleText += " (All Data)";

  chart.options.plugins.title.text = titleText;

  const labels = filteredFeeds.map(f =>
    new Date(f.created_at).toLocaleTimeString("en-GB", {
      hour: "2-digit", minute: "2-digit"
    })
  );

  const temp = filteredFeeds.map(f => Number(f.field1));
  const hum = filteredFeeds.map(f => Number(f.field2));

  const dayLines = [];
  for (let i = 1; i < filteredFeeds.length; i++) {
    const d1 = new Date(filteredFeeds[i - 1].created_at).getDate();
    const d2 = new Date(filteredFeeds[i].created_at).getDate();
    if (d1 !== d2) {
      dayLines.push({
        type: "line",
        xMin: labels[i],
        xMax: labels[i],
        borderColor: "#ef4444",
        borderDash: [6, 6],
        label: {
          content: shortDate(new Date(filteredFeeds[i].created_at)),
          enabled: true,
          position: "start"
        }
      });
    }
  }

  chart.data = {
    labels,
    datasets: [
      { label: "Temperature (Â°C)", data: temp, borderColor: "#f97316", tension: 0.3 },
      { label: "Humidity (%)", data: hum, borderColor: "#38bdf8", tension: 0.3 }
    ]
  };

  chart.options.plugins.annotation = { annotations: dayLines };
  chart.update();

  const last = filteredFeeds.at(-1);
  document.getElementById("temp").innerText = last.field1 + " Â°C";
  document.getElementById("hum").innerText = last.field2 + " %";
  document.getElementById("gas").innerHTML =
    last.field3 == "1"
      ? "<span class='gas-danger'>ðŸš¨ GAS DETECTED</span>"
      : "<span class='gas-safe'>âœ… SAFE</span>";

  document.getElementById("rangeLabel").innerText =
    `Showing data from ${fullTS(start)} to ${fullTS(end)}`;

  const log = document.getElementById("gasLog");
  log.innerHTML = "";
  filteredFeeds.slice().reverse().forEach(f => {
    if (f.field3 == "1") {
      const li = document.createElement("li");
      li.innerText = fullTS(new Date(f.created_at)) + " â†’ GAS DETECTED";
      log.appendChild(li);
    }
  });
}

function downloadCSV() {
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  let csv = `Filter,${currentFilter}\n`;
  csv += `From,${fullTS(start)}\nTo,${fullTS(end)}\n\n`;
  csv += "Timestamp,Temperature,Humidity,Gas\n";

  filteredFeeds.forEach(f => {
    csv += `${fullTS(new Date(f.created_at))},${f.field1},${f.field2},${f.field3}\n`;
  });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = `air_quality_${currentFilter}_${shortDate(start)}_to_${shortDate(end)}.csv`;
  a.click();
}

function downloadPNG() {
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  const a = document.createElement("a");
  a.href = chart.canvas.toDataURL("image/png", 0.7);
  a.download = `air_quality_${currentFilter}_${shortDate(start)}_to_${shortDate(end)}.png`;
  a.click();
}

fetch(url).then(r => r.json()).then(d => {
  rawFeeds = d.feeds;
  filteredFeeds = rawFeeds;
  updateUI();
});

setInterval(() => fetch(url).then(r => r.json()).then(d => {
  rawFeeds = d.feeds;
  applyFilter();
}), 20000);
</script>
