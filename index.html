<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Air Quality Monitoring Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #e5e7eb;
  padding: 20px;
  min-height: 100vh;
}

h1, h2 {
  text-align: center;
  margin-bottom: 25px;
}

h1 {
  color: #38bdf8;
  font-size: 2.5rem;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.guide {
  background: rgba(30, 41, 59, 0.8);
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 30px;
  line-height: 1.6;
  border-left: 4px solid #38bdf8;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.guide h3 {
  color: #38bdf8;
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.guide ul {
  padding-left: 20px;
}

.guide li {
  margin-bottom: 8px;
}

.cards {
  display: flex;
  justify-content: center;
  gap: 25px;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.card {
  background: linear-gradient(145deg, #020617, #0f172a);
  padding: 25px;
  border-radius: 16px;
  width: 280px;
  text-align: center;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-top: 4px solid transparent;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}

.card h3 {
  margin-top: 0;
  font-size: 1.2rem;
  color: #94a3b8;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.card p {
  font-size: 2.5rem;
  font-weight: bold;
  margin: 15px 0;
}

.temp { 
  color: #f97316;
  border-color: #f97316;
}
.hum { 
  color: #38bdf8;
  border-color: #38bdf8;
}
.gas-card { 
  border-color: #22c55e;
}

.gas-safe { 
  color: #22c55e;
  background: rgba(34, 197, 94, 0.1);
  padding: 10px;
  border-radius: 10px;
  display: inline-block;
}
.gas-danger { 
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
  padding: 10px;
  border-radius: 10px;
  display: inline-block;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.controls {
  text-align: center;
  margin: 30px 0;
  padding: 20px;
  background: rgba(30, 41, 59, 0.6);
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.filter-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.controls button {
  margin: 5px;
  padding: 12px 20px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

button:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

button.active {
  background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
  box-shadow: 0 0 0 2px #8b5cf6;
}

.download-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

.download-buttons button {
  background: linear-gradient(135deg, #059669 0%, #10b981 100%);
  min-width: 160px;
}

.download-buttons button:hover {
  background: linear-gradient(135deg, #047857 0%, #059669 100%);
}

.chart-container {
  position: relative;
  background: rgba(2, 6, 23, 0.8);
  padding: 25px;
  border-radius: 16px;
  margin-top: 20px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  border: 1px solid #334155;
}

canvas {
  width: 100% !important;
  height: 400px !important;
}

.rangeLabel {
  text-align: center;
  margin: 20px 0;
  font-size: 1.1rem;
  padding: 15px;
  background: rgba(30, 41, 59, 0.6);
  border-radius: 12px;
  border-left: 4px solid #38bdf8;
}

.stats-bar {
  display: flex;
  justify-content: space-between;
  background: rgba(30, 41, 59, 0.8);
  padding: 15px;
  border-radius: 12px;
  margin-top: 20px;
  font-size: 0.9rem;
  color: #94a3b8;
}

.stat-item {
  text-align: center;
  flex: 1;
}

.stat-value {
  font-size: 1.2rem;
  font-weight: bold;
  color: #e5e7eb;
  display: block;
  margin-top: 5px;
}

.log {
  background: rgba(2, 6, 23, 0.8);
  padding: 25px;
  border-radius: 16px;
  margin-top: 30px;
  max-height: 350px;
  overflow-y: auto;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  border: 1px solid #334155;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.log h2 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.log-count {
  background: #3b82f6;
  color: white;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.9rem;
}

#gasLog {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

#gasLog li {
  padding: 15px;
  margin-bottom: 10px;
  background: rgba(30, 41, 59, 0.6);
  border-radius: 10px;
  border-left: 4px solid #ef4444;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s ease;
}

#gasLog li:hover {
  background: rgba(30, 41, 59, 0.8);
  transform: translateX(5px);
}

.log-time {
  font-weight: bold;
  color: #38bdf8;
}

.log-status {
  font-weight: bold;
  color: #ef4444;
}

.no-events {
  text-align: center;
  padding: 30px;
  color: #94a3b8;
  font-style: italic;
}

.status-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 10px;
}

.status-safe {
  background-color: #22c55e;
  box-shadow: 0 0 8px #22c55e;
}

.status-danger {
  background-color: #ef4444;
  box-shadow: 0 0 8px #ef4444;
}

.filter-info {
  text-align: center;
  margin-top: 10px;
  font-size: 0.9rem;
  color: #94a3b8;
  font-style: italic;
}

.calendar-container {
  background: rgba(2, 6, 23, 0.8);
  padding: 25px;
  border-radius: 16px;
  margin-top: 30px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  border: 1px solid #334155;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day-header {
  text-align: center;
  padding: 10px;
  color: #38bdf8;
  font-weight: bold;
  font-size: 0.9rem;
}

.calendar-day {
  text-align: center;
  padding: 12px 5px;
  border-radius: 8px;
  cursor: default;
  transition: all 0.3s ease;
  position: relative;
}

.calendar-day.empty {
  background: transparent;
}

.calendar-day.has-data {
  background: rgba(34, 197, 94, 0.2);
  border: 1px solid #22c55e;
  color: #22c55e;
  font-weight: bold;
}

.calendar-day.has-data:hover {
  background: rgba(34, 197, 94, 0.3);
  transform: scale(1.05);
}

.calendar-day.no-data {
  background: rgba(148, 163, 184, 0.1);
  color: #94a3b8;
  opacity: 0.5;
}

.calendar-day.today {
  border: 2px solid #f97316;
}

.calendar-day-count {
  position: absolute;
  top: 4px;
  right: 4px;
  background: #3b82f6;
  color: white;
  font-size: 0.7rem;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calendar-month-nav {
  display: flex;
  align-items: center;
  gap: 15px;
}

.calendar-month-nav button {
  background: rgba(59, 130, 246, 0.2);
  border: none;
  color: #38bdf8;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.calendar-month-nav button:hover {
  background: rgba(59, 130, 246, 0.4);
  transform: scale(1.1);
}

.calendar-current-month {
  font-size: 1.3rem;
  font-weight: bold;
  color: #38bdf8;
}

@media (max-width: 768px) {
  .cards {
    flex-direction: column;
    align-items: center;
  }
  
  .card {
    width: 100%;
    max-width: 400px;
  }
  
  .filter-buttons {
    flex-direction: column;
    align-items: center;
  }
  
  .stats-bar {
    flex-wrap: wrap;
  }
  
  .stat-item {
    flex: 1 0 50%;
    margin-bottom: 10px;
  }
  
  .calendar-grid {
    gap: 4px;
  }
  
  .calendar-day {
    padding: 8px 2px;
    font-size: 0.9rem;
  }
}
</style>
</head>

<body>

<h1><i class="fas fa-wind"></i> Air Quality Monitoring Dashboard</h1>

<div class="guide">
  <h3><i class="fas fa-info-circle"></i> How to read the data:</h3>
  <ul>
    <li><i class="fas fa-mouse-pointer"></i> <b>Hover</b> on chart points to see the exact timestamp</li>
    <li><i class="fas fa-clock"></i> X-axis ticks are shown every <b>2 minutes</b> for readability</li>
    <li><i class="fas fa-gas-pump"></i> <b>Gas = 1</b> → Gas detected (unsafe) | <b>Gas = 0</b> → Safe air</li>
    <li><i class="fas fa-calendar-day"></i> Red vertical lines indicate <b>new day</b> transitions</li>
    <li><i class="fas fa-filter"></i> Use filters to view data from specific time periods</li>
    <li><i class="fas fa-calendar-check"></i> <b>Green dates</b> in calendar have recorded data</li>
  </ul>
</div>

<div class="cards">
  <div class="card temp">
    <h3><i class="fas fa-thermometer-half"></i> Temperature</h3>
    <p id="temp">-- °C</p>
    <div class="stat-item">Current Reading</div>
  </div>

  <div class="card hum">
    <h3><i class="fas fa-tint"></i> Humidity</h3>
    <p id="hum">-- %</p>
    <div class="stat-item">Current Reading</div>
  </div>

  <div class="card gas-card">
    <h3><i class="fas fa-exclamation-triangle"></i> Gas Status</h3>
    <p id="gas">--</p>
    <div class="stat-item">Current Status</div>
  </div>
</div>

<div class="controls">
  <div class="filter-buttons">
    <button onclick="setFilter('all')" id="btn-all" class="active">
      <i class="fas fa-globe"></i> All Data
    </button>
    <button onclick="setFilter('7d')" id="btn-7d">
      <i class="fas fa-calendar-week"></i> Last 7 Days
    </button>
    <button onclick="setFilter('1m')" id="btn-1m">
      <i class="fas fa-calendar-alt"></i> Last 1 Month
    </button>
    <button onclick="setFilter('yesterday')" id="btn-yesterday">
      <i class="fas fa-calendar-minus"></i> Yesterday
    </button>
    <button onclick="setFilter('today')" id="btn-today">
      <i class="fas fa-calendar-day"></i> Today
    </button>
  </div>
  
  <div class="filter-info">
    <span id="filterDescription">Showing all available data</span>
  </div>
  
  <div class="download-buttons">
    <button onclick="downloadCSV()">
      <i class="fas fa-file-csv"></i> Download CSV
    </button>
    <button onclick="downloadPNG()">
      <i class="fas fa-chart-line"></i> Download Chart
    </button>
  </div>
</div>

<div class="stats-bar" id="statsBar">
  <div class="stat-item">
    <span>Data Points:</span>
    <span class="stat-value" id="dataPoints">--</span>
  </div>
  <div class="stat-item">
    <span>Gas Events:</span>
    <span class="stat-value" id="gasEvents">--</span>
  </div>
  <div class="stat-item">
    <span>Avg Temp:</span>
    <span class="stat-value" id="avgTemp">-- °C</span>
  </div>
  <div class="stat-item">
    <span>Avg Humidity:</span>
    <span class="stat-value" id="avgHum">-- %</span>
  </div>
</div>

<p class="rangeLabel" id="rangeLabel"></p>

<div class="chart-container">
  <canvas id="chart"></canvas>
</div>

<div class="calendar-container">
  <div class="calendar-header">
    <div class="calendar-month-nav">
      <button onclick="changeMonth(-1)" title="Previous Month">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="calendar-current-month" id="currentMonth">January 2024</div>
      <button onclick="changeMonth(1)" title="Next Month">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    <div class="calendar-legend">
      <small>
        <span style="color:#22c55e"><i class="fas fa-square"></i> Has Data</span> | 
        <span style="color:#f97316"><i class="fas fa-square"></i> Today</span>
      </small>
    </div>
  </div>
  
  <div class="calendar-grid">
    <div class="calendar-day-header">Sun</div>
    <div class="calendar-day-header">Mon</div>
    <div class="calendar-day-header">Tue</div>
    <div class="calendar-day-header">Wed</div>
    <div class="calendar-day-header">Thu</div>
    <div class="calendar-day-header">Fri</div>
    <div class="calendar-day-header">Sat</div>
    
    <!-- Calendar days will be generated by JavaScript -->
    <div id="calendarDays"></div>
  </div>
</div>

<div class="log">
  <div class="log-header">
    <h2><i class="fas fa-history"></i> Gas Detection Log</h2>
    <div class="log-count" id="logCount">0 events</div>
  </div>
  <ul id="gasLog"></ul>
</div>

<script>
const CHANNEL_ID = "3208976";
const READ_API_KEY = "OACUOG6F0U6AJRIT";
const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=500`;

let rawFeeds = [];
let filteredFeeds = [];
let currentFilter = "all";
let calendarCurrentDate = new Date();
let datesWithData = {};

function fullTS(d) {
  return d.toLocaleString("en-GB", {
    day: "2-digit", month: "long", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
}

function shortDate(d) {
  return d.toLocaleDateString("en-GB", {
    day: "2-digit", month: "short", year: "numeric"
  });
}

function formatDateKey(date) {
  return date.toISOString().split('T')[0]; // YYYY-MM-DD
}

function updateButtonStates() {
  const buttons = ['all', '7d', '1m', 'yesterday', 'today'];
  buttons.forEach(btn => {
    const element = document.getElementById(`btn-${btn}`);
    if (element) element.classList.remove('active');
  });
  
  const currentBtn = document.getElementById(`btn-${currentFilter}`);
  if (currentBtn) currentBtn.classList.add('active');
}

function applyFilter() {
  const now = new Date();
  
  if (currentFilter === "all") {
    filteredFeeds = [...rawFeeds];
    updateFilterDescription("Showing all available data");
  }
  
  if (currentFilter === "7d") {
    const cutoffDate = new Date(now); 
    cutoffDate.setDate(cutoffDate.getDate() - 7);
    cutoffDate.setHours(0, 0, 0, 0);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= cutoffDate);
    updateFilterDescription("Showing last 7 days of data");
  }
  
  if (currentFilter === "1m") {
    const cutoffDate = new Date(now); 
    cutoffDate.setMonth(cutoffDate.getMonth() - 1);
    cutoffDate.setHours(0, 0, 0, 0);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= cutoffDate);
    updateFilterDescription("Showing last 1 month of data");
  }
  
  if (currentFilter === "yesterday") {
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0);
    const yesterdayEnd = new Date(yesterday);
    yesterdayEnd.setHours(23, 59, 59, 999);
    
    filteredFeeds = rawFeeds.filter(f => {
      const d = new Date(f.created_at);
      return d >= yesterday && d <= yesterdayEnd;
    });
    updateFilterDescription(`Showing data from ${shortDate(yesterday)} (Yesterday)`);
  }
  
  if (currentFilter === "today") {
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    const todayEnd = new Date(now);
    todayEnd.setHours(23, 59, 59, 999);
    
    filteredFeeds = rawFeeds.filter(f => {
      const d = new Date(f.created_at);
      return d >= today && d <= todayEnd;
    });
    updateFilterDescription(`Showing data from ${shortDate(today)} (Today)`);
  }
  
  updateButtonStates();
  updateUI();
}

function setFilter(f) {
  currentFilter = f;
  applyFilter();
}

function updateFilterDescription(text) {
  document.getElementById("filterDescription").textContent = text;
}

function updateCalendar() {
  // Get current month and year
  const year = calendarCurrentDate.getFullYear();
  const month = calendarCurrentDate.getMonth();
  
  // Update month display
  const monthNames = ["January", "February", "March", "April", "May", "June",
                     "July", "August", "September", "October", "November", "December"];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDay = firstDay.getDay(); // 0 = Sunday
  
  // Clear previous calendar
  const calendarDays = document.getElementById('calendarDays');
  calendarDays.innerHTML = '';
  
  // Add empty cells for days before the first day of the month
  for (let i = 0; i < startingDay; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day empty';
    calendarDays.appendChild(emptyDay);
  }
  
  // Add days of the month
  const today = new Date();
  const todayKey = formatDateKey(today);
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dayDate = new Date(year, month, day);
    const dayKey = formatDateKey(dayDate);
    
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;
    
    // Check if this date has data
    if (datesWithData[dayKey]) {
      dayElement.classList.add('has-data');
      dayElement.title = `${datesWithData[dayKey]} records on ${dayKey}`;
      
      // Add count badge
      const countBadge = document.createElement('div');
      countBadge.className = 'calendar-day-count';
      countBadge.textContent = datesWithData[dayKey];
      dayElement.appendChild(countBadge);
    } else {
      dayElement.classList.add('no-data');
      dayElement.title = `No data recorded on ${dayKey}`;
    }
    
    // Highlight today
    if (dayKey === todayKey) {
      dayElement.classList.add('today');
      dayElement.title += ' (Today)';
    }
    
    calendarDays.appendChild(dayElement);
  }
}

function changeMonth(delta) {
  calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + delta);
  updateCalendar();
}

function analyzeDatesWithData() {
  // Reset datesWithData
  datesWithData = {};
  
  // Count records per date
  rawFeeds.forEach(feed => {
    const date = new Date(feed.created_at);
    const dateKey = formatDateKey(date);
    
    if (!datesWithData[dateKey]) {
      datesWithData[dateKey] = 0;
    }
    datesWithData[dateKey]++;
  });
  
  // Update calendar
  updateCalendar();
}

const chart = new Chart(document.getElementById("chart"), {
  type: "line",
  data: { labels: [], datasets: [] },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { 
      mode: "nearest", 
      intersect: false,
      axis: 'x'
    },
    plugins: {
      tooltip: {
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        titleColor: '#38bdf8',
        bodyColor: '#e5e7eb',
        borderColor: '#334155',
        borderWidth: 1,
        cornerRadius: 8,
        displayColors: false,
        callbacks: {
          title: function(tooltipItems) {
            if (tooltipItems.length > 0) {
              const index = tooltipItems[0].dataIndex;
              if (filteredFeeds[index]) {
                return fullTS(new Date(filteredFeeds[index].created_at));
              }
            }
            return '';
          }
        }
      },
      legend: {
        labels: {
          color: '#94a3b8',
          font: {
            size: 14
          },
          padding: 20
        }
      },
      title: {
        display: true,
        text: "Air Quality Trend (All Data)",
        color: "#e5e7eb",
        font: { 
          size: 20,
          weight: 'bold'
        },
        padding: {
          top: 10,
          bottom: 30
        }
      }
    },
    scales: {
      x: {
        ticks: {
          maxTicksLimit: 20,
          color: "#94a3b8",
          font: {
            size: 12
          }
        },
        grid: { 
          color: "rgba(51, 65, 85, 0.5)",
          drawBorder: false
        },
        title: {
          display: true,
          text: 'Time',
          color: '#94a3b8',
          font: {
            size: 14,
            weight: 'bold'
          }
        }
      },
      y: {
        beginAtZero: false,
        ticks: { 
          color: "#94a3b8",
          font: {
            size: 12
          }
        },
        grid: { 
          color: "rgba(51, 65, 85, 0.5)",
          drawBorder: false
        },
        title: {
          display: true,
          text: 'Value',
          color: '#94a3b8',
          font: {
            size: 14,
            weight: 'bold'
          }
        }
      }
    },
    elements: {
      point: {
        radius: 4,
        hoverRadius: 8,
        backgroundColor: function(context) {
          const index = context.dataIndex;
          const datasetIndex = context.datasetIndex;
          return datasetIndex === 0 ? '#f97316' : '#38bdf8';
        }
      },
      line: {
        borderWidth: 3
      }
    }
  }
});

function updateStats() {
  if (!filteredFeeds.length) {
    document.getElementById("dataPoints").textContent = "0";
    document.getElementById("gasEvents").textContent = "0";
    document.getElementById("avgTemp").textContent = "-- °C";
    document.getElementById("avgHum").textContent = "-- %";
    return;
  }
  
  const dataPoints = filteredFeeds.length;
  const gasEvents = filteredFeeds.filter(f => f.field3 == "1").length;
  
  const temps = filteredFeeds.map(f => parseFloat(f.field1)).filter(t => !isNaN(t));
  const hums = filteredFeeds.map(f => parseFloat(f.field2)).filter(h => !isNaN(h));
  
  const avgTemp = temps.length ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) : "--";
  const avgHum = hums.length ? (hums.reduce((a, b) => a + b, 0) / hums.length).toFixed(1) : "--";
  
  document.getElementById("dataPoints").textContent = dataPoints;
  document.getElementById("gasEvents").textContent = gasEvents;
  document.getElementById("avgTemp").textContent = avgTemp + " °C";
  document.getElementById("avgHum").textContent = avgHum + " %";
}

function updateUI() {
  if (!filteredFeeds.length) {
    document.getElementById("rangeLabel").innerText = "No data available for the selected filter";
    return;
  }

  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  // Dynamic chart title
  let titleText = "Air Quality Trend";
  if (currentFilter === "7d") titleText += " (Last 7 Days)";
  else if (currentFilter === "1m") titleText += " (Last 1 Month)";
  else if (currentFilter === "yesterday") titleText += " (Yesterday)";
  else if (currentFilter === "today") titleText += " (Today)";
  else titleText += " (All Data)";

  chart.options.plugins.title.text = titleText;

  // Create labels
  const labels = filteredFeeds.map(f => {
    const date = new Date(f.created_at);
    return date.toLocaleTimeString("en-GB", {
      hour: "2-digit", 
      minute: "2-digit",
      hour12: false
    });
  });

  const temp = filteredFeeds.map(f => Number(f.field1));
  const hum = filteredFeeds.map(f => Number(f.field2));

  // Add day change annotations
  const dayLines = [];
  let lastDate = null;
  
  filteredFeeds.forEach((feed, index) => {
    const currentDate = new Date(feed.created_at).toDateString();
    if (lastDate !== null && currentDate !== lastDate && index > 0) {
      dayLines.push({
        type: "line",
        xMin: index - 0.5,
        xMax: index - 0.5,
        borderColor: "#ef4444",
        borderDash: [6, 6],
        borderWidth: 2,
        label: {
          content: shortDate(new Date(feed.created_at)),
          enabled: true,
          position: "start",
          backgroundColor: "rgba(239, 68, 68, 0.1)",
          color: "#ef4444",
          font: {
            size: 12,
            weight: 'bold'
          }
        }
      });
    }
    lastDate = currentDate;
  });

  chart.data = {
    labels,
    datasets: [
      { 
        label: "Temperature (°C)", 
        data: temp, 
        borderColor: "#f97316", 
        backgroundColor: "rgba(249, 115, 22, 0.1)",
        tension: 0.2,
        fill: true
      },
      { 
        label: "Humidity (%)", 
        data: hum, 
        borderColor: "#38bdf8", 
        backgroundColor: "rgba(56, 189, 248, 0.1)",
        tension: 0.2,
        fill: true
      }
    ]
  };

  chart.options.plugins.annotation = { annotations: dayLines };
  chart.update();

  // Update current readings
  const last = filteredFeeds.at(-1);
  document.getElementById("temp").innerText = last.field1 + " °C";
  document.getElementById("hum").innerText = last.field2 + " %";
  
  const gasElement = document.getElementById("gas");
  if (last.field3 == "1") {
    gasElement.innerHTML = '<span class="gas-danger"><i class="fas fa-exclamation-circle"></i> GAS DETECTED</span>';
  } else {
    gasElement.innerHTML = '<span class="gas-safe"><i class="fas fa-check-circle"></i> SAFE</span>';
  }

  // Update range label
  document.getElementById("rangeLabel").innerHTML = 
    `<i class="fas fa-calendar-alt"></i> Showing data from <b>${fullTS(start)}</b> to <b>${fullTS(end)}</b>`;

  // Update logs
  updateLogs();
  
  // Update statistics
  updateStats();
}

function updateLogs() {
  const log = document.getElementById("gasLog");
  log.innerHTML = "";
  
  // Get gas detection events from filtered feeds
  const gasEvents = filteredFeeds
    .filter(f => f.field3 == "1")
    .slice()
    .reverse();
  
  const logCount = document.getElementById("logCount");
  logCount.textContent = `${gasEvents.length} event${gasEvents.length !== 1 ? 's' : ''}`;
  
  if (gasEvents.length === 0) {
    const li = document.createElement("li");
    li.className = "no-events";
    li.innerHTML = `
      <i class="fas fa-check" style="font-size: 2rem; margin-bottom: 10px; display: block; color: #22c55e;"></i>
      <div>No gas detection events in the selected range</div>
      <div style="font-size: 0.9rem; margin-top: 5px;">Air quality is safe</div>
    `;
    log.appendChild(li);
  } else {
    gasEvents.forEach(f => {
      const li = document.createElement("li");
      const eventTime = new Date(f.created_at);
      
      li.innerHTML = `
        <div>
          <span class="status-indicator status-danger"></span>
          <span class="log-time">${fullTS(eventTime)}</span>
        </div>
        <div class="log-status">GAS DETECTED</div>
      `;
      log.appendChild(li);
    });
  }
}

function downloadCSV() {
  if (!filteredFeeds.length) {
    alert("No data available to download");
    return;
  }
  
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);
  
  // Clean CSV content - remove special characters and ensure proper formatting
  let csv = "AIR QUALITY MONITORING DATA\n";
  csv += "Generated: " + fullTS(new Date()) + "\n";
  csv += "Filter: " + currentFilter.toUpperCase() + "\n";
  csv += "Date Range: " + shortDate(start) + " to " + shortDate(end) + "\n\n";
  
  // Header
  csv += "Timestamp,Temperature (C),Humidity (%),Gas Status,Notes\n";
  
  filteredFeeds.forEach(f => {
    const timestamp = fullTS(new Date(f.created_at));
    const temp = f.field1 || "N/A";
    const hum = f.field2 || "N/A";
    const gasStatus = f.field3 == "1" ? "GAS DETECTED" : "SAFE";
    
    // Clean notes - remove any non-printable characters
    let notes = "";
    if (f.field3 == "1") notes = "Alert: Gas detected";
    if (parseFloat(temp) > 35) notes += (notes ? "; " : "") + "High temperature";
    if (parseFloat(hum) > 80) notes += (notes ? "; " : "") + "High humidity";
    if (!notes) notes = "Normal conditions";
    
    // Clean all fields to remove special characters
    const cleanTimestamp = timestamp.replace(/[^\x20-\x7E]/g, '');
    const cleanTemp = temp.toString().replace(/[^\x20-\x7E]/g, '');
    const cleanHum = hum.toString().replace(/[^\x20-\x7E]/g, '');
    const cleanGasStatus = gasStatus.replace(/[^\x20-\x7E]/g, '');
    const cleanNotes = notes.replace(/[^\x20-\x7E]/g, '');
    
    csv += `"${cleanTimestamp}",${cleanTemp},${cleanHum},"${cleanGasStatus}","${cleanNotes}"\n`;
  });
  
  // Add summary statistics
  csv += "\nSUMMARY STATISTICS\n";
  csv += "Total Records," + filteredFeeds.length + "\n";
  
  const gasEvents = filteredFeeds.filter(f => f.field3 == "1").length;
  csv += "Gas Detection Events," + gasEvents + "\n";
  
  const temps = filteredFeeds.map(f => parseFloat(f.field1)).filter(t => !isNaN(t));
  const hums = filteredFeeds.map(f => parseFloat(f.field2)).filter(h => !isNaN(h));
  
  if (temps.length > 0) {
    const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1);
    const minTemp = Math.min(...temps).toFixed(1);
    const maxTemp = Math.max(...temps).toFixed(1);
    csv += "Temperature - Avg (C)," + avgTemp + "\n";
    csv += "Temperature - Min (C)," + minTemp + "\n";
    csv += "Temperature - Max (C)," + maxTemp + "\n";
  }
  
  if (hums.length > 0) {
    const avgHum = (hums.reduce((a, b) => a + b, 0) / hums.length).toFixed(1);
    const minHum = Math.min(...hums).toFixed(1);
    const maxHum = Math.max(...hums).toFixed(1);
    csv += "Humidity - Avg (%)," + avgHum + "\n";
    csv += "Humidity - Min (%)," + minHum + "\n";
    csv += "Humidity - Max (%)," + maxHum + "\n";
  }
  
  // Create filename based on filter
  let filename;
  const currentDate = new Date();
  const dateStr = currentDate.toISOString().split('T')[0];
  
  if (currentFilter === "custom") {
    const fromStr = start.toISOString().split('T')[0];
    const toStr = end.toISOString().split('T')[0];
    filename = `Air_Quality_${fromStr}_to_${toStr}.csv`;
  } else {
    filename = `Air_Quality_${currentFilter}_${dateStr}.csv`;
  }
  
  // Clean filename
  filename = filename.replace(/[^\w\-.]/g, '_');
  
  // Create and download CSV
  const a = document.createElement("a");
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadPNG() {
  if (!filteredFeeds.length) {
    alert("No chart available to download");
    return;
  }
  
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);
  
  // Create filename
  let filename;
  const currentDate = new Date();
  const dateStr = currentDate.toISOString().split('T')[0];
  
  if (currentFilter === "custom") {
    const fromStr = start.toISOString().split('T')[0];
    const toStr = end.toISOString().split('T')[0];
    filename = `Air_Quality_Chart_${fromStr}_to_${toStr}.png`;
  } else {
    filename = `Air_Quality_Chart_${currentFilter}_${dateStr}.png`;
  }
  
  // Clean filename
  filename = filename.replace(/[^\w\-.]/g, '_');

  const a = document.createElement("a");
  a.href = chart.canvas.toDataURL("image/png", 1.0);
  a.download = filename;
  a.click();
}

// Initialize the dashboard
fetch(url)
  .then(r => r.json())
  .then(d => {
    rawFeeds = d.feeds;
    filteredFeeds = rawFeeds;
    analyzeDatesWithData();
    updateUI();
  })
  .catch(error => {
    console.error("Error fetching data:", error);
    document.getElementById("rangeLabel").innerText = "Error loading data. Please check your connection.";
  });

// Auto-refresh every 20 seconds
setInterval(() => {
  fetch(url)
    .then(r => r.json())
    .then(d => {
      rawFeeds = d.feeds;
      analyzeDatesWithData();
      applyFilter();
    })
    .catch(error => {
      console.error("Error refreshing data:", error);
    });
}, 20000);
</script>

</body>
</html>
