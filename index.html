<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Air Quality Monitoring Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

h1, h2 {
  text-align: center;
}

.guide {
  background: #1e293b;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 25px;
  line-height: 1.6;
}

.guide span {
  font-weight: bold;
  color: #38bdf8;
}

.cards {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

.card {
  background: #020617;
  padding: 20px;
  border-radius: 12px;
  width: 260px;
  text-align: center;
}

.temp { color: #f97316; }
.hum { color: #38bdf8; }
.gas-safe { color: #22c55e; }
.gas-danger { color: #ef4444; }

.controls {
  text-align: center;
  margin: 25px 0;
}

.controls button, .controls input {
  margin: 5px;
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
}

button {
  background: #2563eb;
  color: white;
  cursor: pointer;
}

canvas {
  background: #020617;
  padding: 15px;
  border-radius: 12px;
  margin-top: 20px;
}

.rangeLabel {
  text-align: center;
  margin-top: 10px;
  font-style: italic;
}

.log {
  background: #020617;
  padding: 15px;
  border-radius: 12px;
  margin-top: 25px;
  max-height: 250px;
  overflow-y: auto;
}
</style>
</head>

<body>

<h1>üåç Air Quality Monitoring Dashboard</h1>

<div class="guide">
  <p><span>How to read the data:</span></p>
  <ul>
    <li>Hover on chart points to see the <b>exact timestamp</b></li>
    <li>X-axis ticks are shown every <b>2 minutes</b> for readability</li>
    <li><b>Gas = 1</b> ‚Üí Gas detected (unsafe)</li>
    <li><b>Gas = 0</b> ‚Üí Safe air</li>
    <li>Red vertical lines indicate <b>new day</b></li>
  </ul>
</div>

<div class="cards">
  <div class="card temp">
    <h3>Temperature</h3>
    <p id="temp">-- ¬∞C</p>
  </div>

  <div class="card hum">
    <h3>Humidity</h3>
    <p id="hum">-- %</p>
  </div>

  <div class="card">
    <h3>Gas Status</h3>
    <p id="gas">--</p>
  </div>
</div>

<div class="controls">
  <button onclick="setFilter('all')">All</button>
  <button onclick="setFilter('7d')">Last 7 Days</button>
  <button onclick="setFilter('1m')">Last 1 Month</button>
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="setCustom()">Apply Date</button>
  <br><br>
  <button onclick="downloadCSV()">‚¨á CSV</button>
  <button onclick="downloadPNG()">üñº Chart</button>
</div>

<p class="rangeLabel" id="rangeLabel"></p>

<canvas id="chart"></canvas>

<div class="log">
  <h2>üïí Gas Detection Log</h2>
  <ul id="gasLog"></ul>
</div>

<script>
const CHANNEL_ID = "3208976";
const READ_API_KEY = "OACUOG6F0U6AJRIT";
const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=500`;

let rawFeeds = [];
let filteredFeeds = [];
let currentFilter = "all";

function fullTS(d) {
  return d.toLocaleString("en-GB", {
    day: "2-digit", month: "long", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
}

function shortDate(d) {
  return d.toLocaleDateString("en-GB", {
    day: "2-digit", month: "short", year: "numeric"
  });
}

function applyFilter() {
  const now = new Date();
  filteredFeeds = [...rawFeeds];

  if (currentFilter === "7d") {
    const c = new Date(now); 
    c.setDate(c.getDate() - 7);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= c);
  }

  if (currentFilter === "1m") {
    const c = new Date(now); 
    c.setMonth(c.getMonth() - 1);
    filteredFeeds = rawFeeds.filter(f => new Date(f.created_at) >= c);
  }

  updateUI();
}

function setFilter(f) {
  currentFilter = f;
  applyFilter();
}

function setCustom() {
  const f = new Date(document.getElementById("fromDate").value);
  const t = new Date(document.getElementById("toDate").value);

  filteredFeeds = rawFeeds.filter(x => {
    const d = new Date(x.created_at);
    return d >= f && d <= t;
  });

  currentFilter = "custom";
  updateUI();
}

const chart = new Chart(document.getElementById("chart"), {
  type: "line",
  data: { labels: [], datasets: [] },
  options: {
    interaction: { mode: "nearest", intersect: false },
    plugins: {
      title: {
        display: true,
        text: "Air Quality Trend (All Data)",
        color: "#e5e7eb",
        font: { size: 16 }
      }
    }
  }
});

function updateUI() {
  if (!filteredFeeds.length) return;

  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  // ----- Dynamic chart title -----
  let titleText = "Air Quality Trend";
  if (currentFilter === "7d") titleText += " (Last 7 Days)";
  else if (currentFilter === "1m") titleText += " (Last 1 Month)";
  else if (currentFilter === "custom")
    titleText += ` (${shortDate(start)} ‚Üí ${shortDate(end)})`;
  else titleText += " (All Data)";

  chart.options.plugins.title.text = titleText;

  const labels = filteredFeeds.map(f =>
    new Date(f.created_at).toLocaleTimeString("en-GB", {
      hour: "2-digit", minute: "2-digit"
    })
  );

  const temp = filteredFeeds.map(f => Number(f.field1));
  const hum = filteredFeeds.map(f => Number(f.field2));

  const dayLines = [];
  for (let i = 1; i < filteredFeeds.length; i++) {
    const d1 = new Date(filteredFeeds[i - 1].created_at).getDate();
    const d2 = new Date(filteredFeeds[i].created_at).getDate();
    if (d1 !== d2) {
      dayLines.push({
        type: "line",
        xMin: labels[i],
        xMax: labels[i],
        borderColor: "#ef4444",
        borderDash: [6, 6],
        label: {
          content: shortDate(new Date(filteredFeeds[i].created_at)),
          enabled: true,
          position: "start"
        }
      });
    }
  }

  chart.data = {
    labels,
    datasets: [
      { label: "Temperature (¬∞C)", data: temp, borderColor: "#f97316", tension: 0.3 },
      { label: "Humidity (%)", data: hum, borderColor: "#38bdf8", tension: 0.3 }
    ]
  };

  chart.options.plugins.annotation = { annotations: dayLines };
  chart.update();

  const last = filteredFeeds.at(-1);
  document.getElementById("temp").innerText = last.field1 + " ¬∞C";
  document.getElementById("hum").innerText = last.field2 + " %";
  document.getElementById("gas").innerHTML =
    last.field3 == "1"
      ? "<span class='gas-danger'>üö® GAS DETECTED</span>"
      : "<span class='gas-safe'>‚úÖ SAFE</span>";

  document.getElementById("rangeLabel").innerText =
    `Showing data from ${fullTS(start)} to ${fullTS(end)}`;

  const log = document.getElementById("gasLog");
  log.innerHTML = "";
  filteredFeeds.slice().reverse().forEach(f => {
    if (f.field3 == "1") {
      const li = document.createElement("li");
      li.innerText = fullTS(new Date(f.created_at)) + " ‚Üí GAS DETECTED";
      log.appendChild(li);
    }
  });
}

function downloadCSV() {
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  let csv = `Filter,${currentFilter}\n`;
  csv += `From,${fullTS(start)}\nTo,${fullTS(end)}\n\n`;
  csv += "Timestamp,Temperature,Humidity,Gas\n";

  filteredFeeds.forEach(f => {
    csv += `${fullTS(new Date(f.created_at))},${f.field1},${f.field2},${f.field3}\n`;
  });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv]));
  a.download = `air_quality_${currentFilter}_${shortDate(start)}_to_${shortDate(end)}.csv`;
  a.click();
}

function downloadPNG() {
  const start = new Date(filteredFeeds[0].created_at);
  const end = new Date(filteredFeeds.at(-1).created_at);

  const a = document.createElement("a");
  a.href = chart.canvas.toDataURL("image/png", 0.7);
  a.download = `air_quality_${currentFilter}_${shortDate(start)}_to_${shortDate(end)}.png`;
  a.click();
}

fetch(url).then(r => r.json()).then(d => {
  rawFeeds = d.feeds;
  filteredFeeds = rawFeeds;
  updateUI();
});

setInterval(() => fetch(url).then(r => r.json()).then(d => {
  rawFeeds = d.feeds;
  applyFilter();
}), 20000);
</script>

</body>
</html>

